<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Manage Approvals</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: #ffffff;
            color: #172b4d;
            font-size: 14px;
            line-height: 1.4;
            box-sizing: border-box;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #091e4208;
            transition: background-color 0.1s ease;
            cursor: pointer;
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
            border-radius: 3px;
        }
        
        .member-item:hover {
            background-color: #091e4208;
        }
        
        .member-item.selected {
            background-color: #e4f3ff;
            border: 1px solid #0079bf;
        }
        
        .member-checkbox {
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #0079bf;
        }
        
        /* Trello-style avatars */
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            overflow: hidden;
            background: linear-gradient(45deg, #0079bf, #026aa7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            box-shadow: 0 1px 1px rgba(9, 30, 66, 0.25);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .member-info {
            flex: 1;
            min-width: 0;
        }
        
        .member-name {
            font-weight: 500;
            color: #172b4d;
            margin-bottom: 1px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .member-username {
            color: #6b778c;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .action-buttons {
            margin-top: 16px;
            display: flex;
            gap: 8px;
            padding-top: 16px;
            border-top: 1px solid #dfe1e6;
        }
        
        .save-button, .delete-button {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
            transition: all 0.1s ease;
        }
        
        .save-button {
            background-color: #0079bf;
            color: white;
        }
        
        .save-button:hover:not(:disabled) {
            background-color: #005a8b;
        }
        
        .save-button:disabled {
            background-color: #dfe1e6;
            color: #a5adba;
            cursor: not-allowed;
        }
        
        .delete-button {
            background-color: #eb5a46;
            color: white;
        }
        
        .delete-button:hover {
            background-color: #cf513d;
        }
        
        .selected-count {
            color: #6b778c;
            font-size: 12px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dfe1e6;
        }
        
        .selected-count.has-selection {
            color: #0079bf;
            font-weight: 500;
        }
        
        .members-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 32px;
            color: #6b778c;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #dfe1e6;
            border-radius: 50%;
            border-top-color: #0079bf;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 32px;
            color: #eb5a46;
        }
        
        .error button {
            margin-top: 12px;
            padding: 8px 16px;
            background-color: #eb5a46;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .error button:hover {
            background-color: #cf513d;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Member count info */
        .member-count {
            font-size: 12px;
            color: #6b778c;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading board members...</p>
    </div>
    
    <div id="content" class="content hidden">
        <div id="member-count" class="member-count"></div>
        <div id="selected-count" class="selected-count">No members selected</div>
        <div id="members-list" class="members-list"></div>
        
        <div class="action-buttons">
            <button id="save-button" class="save-button" disabled>
                Save Changes
            </button>
            <button id="delete-button" class="delete-button hidden">
                Delete All
            </button>
        </div>
    </div>
    
    <div id="error" class="error hidden">
        <p>Unable to load board members</p>
        <button id="retry-btn">Retry</button>
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();
        var allMembers = [];
        var selectedMembers = [];
        var existingApprovals = null;

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            var errorDiv = document.getElementById('error');
            var errorMsg = errorDiv.querySelector('p');
            errorMsg.textContent = message || 'Unable to load board members';
        }
        
        function loadData() {
            showLoading();
            
            Promise.all([
                loadBoardMembers(),
                t.get('card', 'shared', 'approvals', null)
            ])
            .then(function(results) {
                allMembers = results[0];
                existingApprovals = results[1];
                
                console.log('Board members:', allMembers);
                console.log('Existing approvals:', existingApprovals);
                
                if (existingApprovals && existingApprovals.members) {
                    // Pre-select existing members
                    selectedMembers = Object.keys(existingApprovals.members);
                    document.getElementById('delete-button').classList.remove('hidden');
                }
                
                displayMembers(allMembers);
                updateSelectedCount();
                showContent();
            })
            .catch(function(error) {
                console.error('Error loading data:', error);
                showError('Unable to load data. Please try again.');
            });
        }
        
        function loadBoardMembers() {
            return new Promise(function(resolve, reject) {
                console.log('Starting to load board members...');
                
                t.board('all')
                .then(function(board) {
                    console.log('Board info:', board);
                    
                    if (board.members && board.members.length > 0) {
                        console.log('Found members in board.members:', board.members.length);
                        resolve(board.members);
                        return;
                    }
                    
                    if (board.idOrganization) {
                        console.log('Board has organization:', board.idOrganization);
                        return t.organization('all');
                    } else {
                        console.log('Board is not part of a workspace, trying board members');
                        return t.board('members');
                    }
                })
                .then(function(result) {
                    if (!result) return; // Already resolved above
                    
                    if (result.id && result.name && result.hasOwnProperty('members')) {
                        console.log('Organization info:', result);
                        if (result.members && result.members.length > 0) {
                            resolve(result.members);
                            return;
                        } else {
                            return t.board('members');
                        }
                    } else {
                        console.log('Board members result:', result);
                        var members = null;
                        
                        if (Array.isArray(result)) {
                            members = result;
                        } else if (result.members) {
                            if (result.members.members && Array.isArray(result.members.members)) {
                                members = result.members.members;
                            } else if (Array.isArray(result.members)) {
                                members = result.members;
                            }
                        }
                        
                        if (members && members.length > 0) {
                            resolve(members);
                        } else {
                            throw new Error('No board members found');
                        }
                    }
                })
                .catch(function(error) {
                    console.error('Error loading members:', error);
                    reject(error);
                });
            });
        }
        
        function displayMembers(members) {
            var membersList = document.getElementById('members-list');
            var memberCount = document.getElementById('member-count');
            
            memberCount.textContent = members.length + ' member' + (members.length !== 1 ? 's' : '') + ' available';
            membersList.innerHTML = '';
            
            members.sort(function(a, b) {
                var nameA = a.fullName || a.username || '';
                var nameB = b.fullName || b.username || '';
                return nameA.localeCompare(nameB);
            });
            
            members.forEach(function(member) {
                var memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.dataset.memberId = member.id;
                
                var isSelected = selectedMembers.includes(member.id);
                if (isSelected) {
                    memberItem.classList.add('selected');
                }
                
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'member-checkbox';
                checkbox.checked = isSelected;
                checkbox.addEventListener('change', function() {
                    toggleMemberSelection(member.id);
                });
                
                var avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                var avatarUrl = member.avatar || member.avatarUrl;
                if (avatarUrl) {
                    var img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = member.fullName || member.username || 'Member';
                    img.onerror = function() {
                        avatar.innerHTML = '';
                        avatar.textContent = getInitials(member);
                    };
                    avatar.appendChild(img);
                } else {
                    avatar.textContent = getInitials(member);
                }
                
                var memberInfo = document.createElement('div');
                memberInfo.className = 'member-info';
                
                var name = document.createElement('div');
                name.className = 'member-name';
                name.textContent = member.fullName || member.username || 'Unknown Member';
                
                memberInfo.appendChild(name);
                
                if (member.username && member.fullName) {
                    var username = document.createElement('div');
                    username.className = 'member-username';
                    username.textContent = '@' + member.username;
                    memberInfo.appendChild(username);
                }
                
                memberItem.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                        toggleMemberSelection(member.id);
                    }
                });
                
                memberItem.appendChild(checkbox);
                memberItem.appendChild(avatar);
                memberItem.appendChild(memberInfo);
                
                membersList.appendChild(memberItem);
            });
        }
        
        function getInitials(member) {
            if (member.fullName) {
                var parts = member.fullName.split(' ');
                return parts.length > 1 ? 
                    parts[0].charAt(0).toUpperCase() + parts[parts.length-1].charAt(0).toUpperCase() :
                    parts[0].charAt(0).toUpperCase();
            } else if (member.username) {
                return member.username.charAt(0).toUpperCase();
            }
            return '?';
        }
        
        function toggleMemberSelection(memberId) {
            var index = selectedMembers.indexOf(memberId);
            var memberItem = document.querySelector('[data-member-id="' + memberId + '"]');
            
            if (index > -1) {
                selectedMembers.splice(index, 1);
                memberItem.classList.remove('selected');
            } else {
                selectedMembers.push(memberId);
                memberItem.classList.add('selected');
            }
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            var selectedCountEl = document.getElementById('selected-count');
            var saveButton = document.getElementById('save-button');
            
            if (selectedMembers.length > 0) {
                selectedCountEl.textContent = selectedMembers.length + ' member' + 
                    (selectedMembers.length !== 1 ? 's' : '') + ' selected';
                selectedCountEl.classList.add('has-selection');
                saveButton.disabled = false;
            } else {
                selectedCountEl.textContent = 'No members selected';
                selectedCountEl.classList.remove('has-selection');
                saveButton.disabled = true;
            }
        }
        
        function saveApprovals() {
            console.log('Saving approvals for members:', selectedMembers);
            
            if (selectedMembers.length === 0) {
                alert('Please select at least one member.');
                return;
            }
            
            var approvalData = {
                members: {},
                createdAt: existingApprovals ? existingApprovals.createdAt : new Date().toISOString(),
                createdBy: null
            };
            
            // Initialize selected members with pending status (or keep existing status)
            selectedMembers.forEach(function(memberId) {
                var member = allMembers.find(function(m) { return m.id === memberId; });
                
                // Keep existing status if member was already in approvals, otherwise set to pending
                var existingStatus = 'pending';
                var existingActionDate = null;
                
                if (existingApprovals && existingApprovals.members[memberId]) {
                    existingStatus = existingApprovals.members[memberId].status;
                    existingActionDate = existingApprovals.members[memberId].actionDate;
                }
                
                approvalData.members[memberId] = {
                    id: memberId,
                    fullName: member.fullName,
                    username: member.username,
                    avatarUrl: member.avatar || member.avatarUrl,
                    status: existingStatus,
                    actionDate: existingActionDate
                };
            });
            
            t.member('all')
            .then(function(currentMember) {
                approvalData.createdBy = existingApprovals ? existingApprovals.createdBy : currentMember.id;
                
                return t.set('card', 'shared', 'approvals', approvalData);
            })
            .then(function() {
                console.log('Approvals saved successfully');
                t.closePopup();
            })
            .catch(function(error) {
                console.error('Error saving approvals:', error);
                alert('Failed to save approvals. Please try again.');
            });
        }
        
        function deleteApprovals() {
            if (!confirm('Are you sure you want to delete all approvals for this card? This action cannot be undone.')) {
                return;
            }
            
            t.remove('card', 'shared', 'approvals')
            .then(function() {
                console.log('Approvals deleted successfully');
                t.closePopup();
            })
            .catch(function(error) {
                console.error('Error deleting approvals:', error);
                alert('Failed to delete approvals. Please try again.');
            });
        }
        
        // Event listeners
        document.getElementById('retry-btn').addEventListener('click', function() {
            loadData();
        });
        
        document.getElementById('save-button').addEventListener('click', function() {
            saveApprovals();
        });
        
        document.getElementById('delete-button').addEventListener('click', function() {
            deleteApprovals();
        });
        
        // Load data when popup opens
        loadData();
    </script>
</body>
</html>