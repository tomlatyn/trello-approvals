<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Workspace Members</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading workspace members...</p>
    </div>
    
    <div id="content" class="content hidden">
        <div class="header">
            <h3>Workspace Members</h3>
            <div id="member-count" class="member-count"></div>
        </div>
        <div id="members-list" class="members-list"></div>
    </div>
    
    <div id="error" class="error hidden">
        <p>Unable to load workspace members</p>
        <button id="retry-btn" class="btn">Retry</button>
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            var errorDiv = document.getElementById('error');
            var errorMsg = errorDiv.querySelector('p');
            errorMsg.textContent = message || 'Unable to load workspace members';
        }
        
        function loadWorkspaceMembers() {
            showLoading();
            
            console.log('Starting to load workspace members...');
            
            // First try to get board information
            t.board('all')
            .then(function(board) {
                console.log('Board info:', board);
                
                // Check if we have organization info
                if (board.idOrganization) {
                    console.log('Board has organization:', board.idOrganization);
                    // Try to get organization info
                    return t.organization('all');
                } else {
                    console.log('Board is not part of a workspace, showing board members');
                    // Fallback to board members
                    return t.board('members').then(function(members) {
                        if (members && members.length > 0) {
                            displayMembers(members);
                            showContent();
                            
                            // Update header to show it's board members
                            var header = document.querySelector('.header h3');
                            header.textContent = 'Board Members';
                            return;
                        } else {
                            throw new Error('No board members found');
                        }
                    });
                }
            })
            .then(function(org) {
                if (!org) return; // Already handled board members case above
                
                console.log('Organization info:', org);
                
                // Try to get organization members using available methods
                if (org.members) {
                    // If organization object includes members
                    console.log('Found members in organization object');
                    displayMembers(org.members);
                    showContent();
                } else {
                    // Try alternative approach - get board members as fallback
                    console.log('No members in org object, falling back to board members');
                    return t.board('members').then(function(members) {
                        if (members && members.length > 0) {
                            displayMembers(members);
                            showContent();
                            
                            // Update header to indicate limited scope
                            var header = document.querySelector('.header h3');
                            header.textContent = 'Board Members (Limited Access)';
                        } else {
                            throw new Error('No members found');
                        }
                    });
                }
            })
            .catch(function(error) {
                console.error('Error loading members:', error);
                
                // Try one more fallback - current member only
                t.member('all').then(function(currentMember) {
                    if (currentMember) {
                        console.log('Showing current member as fallback');
                        displayMembers([currentMember]);
                        showContent();
                        
                        var header = document.querySelector('.header h3');
                        header.textContent = 'Current Member';
                    } else {
                        throw new Error('No member data available');
                    }
                }).catch(function(finalError) {
                    console.error('All methods failed:', finalError);
                    
                    var errorMessage = 'Unable to load members. ';
                    if (error.message.includes('workspace')) {
                        errorMessage += 'Make sure this board is part of a workspace/team.';
                    } else if (error.message.includes('permission')) {
                        errorMessage += 'Insufficient permissions to access member data.';
                    } else {
                        errorMessage += 'Please try again or contact support.';
                    }
                    
                    showError(errorMessage);
                });
            });
        }
        
        function displayMembers(members) {
            var membersList = document.getElementById('members-list');
            var memberCount = document.getElementById('member-count');
            
            console.log('Displaying members:', members);
            
            // Update member count
            memberCount.textContent = members.length + ' member' + (members.length !== 1 ? 's' : '');
            
            // Clear existing content
            membersList.innerHTML = '';
            
            // Sort members by full name
            members.sort(function(a, b) {
                var nameA = a.fullName || a.username || '';
                var nameB = b.fullName || b.username || '';
                return nameA.localeCompare(nameB);
            });
            
            // Create member items
            members.forEach(function(member) {
                var memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                var avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                // Handle different avatar URL formats
                var avatarUrl = member.avatarUrl;
                if (avatarUrl) {
                    // Ensure we have the right avatar URL format
                    if (!avatarUrl.includes('/50.png') && !avatarUrl.includes('/170.png')) {
                        avatarUrl = avatarUrl + '/50.png';
                    }
                    
                    var img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = member.fullName || member.username || 'Member';
                    img.onerror = function() {
                        // Fallback to initials if image fails to load
                        avatar.innerHTML = '';
                        avatar.textContent = member.initials || 
                            (member.username ? member.username.charAt(0).toUpperCase() : '?');
                        avatar.classList.add('avatar-initials');
                    };
                    avatar.appendChild(img);
                } else {
                    // Use initials
                    avatar.textContent = member.initials || 
                        (member.username ? member.username.charAt(0).toUpperCase() : 
                         (member.fullName ? member.fullName.charAt(0).toUpperCase() : '?'));
                    avatar.classList.add('avatar-initials');
                }
                
                var memberInfo = document.createElement('div');
                memberInfo.className = 'member-info';
                
                var name = document.createElement('div');
                name.className = 'member-name';
                name.textContent = member.fullName || member.username || 'Unknown Member';
                
                memberInfo.appendChild(name);
                
                if (member.username) {
                    var username = document.createElement('div');
                    username.className = 'member-username';
                    username.textContent = '@' + member.username;
                    memberInfo.appendChild(username);
                }
                
                if (member.memberType && member.memberType !== 'normal') {
                    var memberType = document.createElement('div');
                    memberType.className = 'member-type';
                    memberType.textContent = member.memberType;
                    memberInfo.appendChild(memberType);
                }
                
                memberItem.appendChild(avatar);
                memberItem.appendChild(memberInfo);
                
                membersList.appendChild(memberItem);
            });
        }
        
        // Retry button functionality
        document.getElementById('retry-btn').addEventListener('click', function() {
            loadWorkspaceMembers();
        });
        
        // Debug function to test what's available
        function debugCapabilities() {
            console.log('=== Debugging Power-Up Capabilities ===');
            
            console.log('Available methods on t:', Object.keys(t));
            
            t.board('all').then(board => {
                console.log('Board data:', board);
                console.log('Board members available:', !!board.members);
                console.log('Organization ID:', board.idOrganization);
            }).catch(e => console.log('Board access error:', e));
            
            t.organization('all').then(org => {
                console.log('Organization data:', org);
                console.log('Org members available:', !!org.members);
            }).catch(e => console.log('Organization access error:', e));
            
            t.member('all').then(member => {
                console.log('Current member data:', member);
            }).catch(e => console.log('Member access error:', e));
        }
        
        // Run debug on load
        debugCapabilities();
        
        // Load members when popup opens
        loadWorkspaceMembers();
    </script>
</body>
</html>