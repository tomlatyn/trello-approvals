<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DEBUG - Member Loading</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .debug-section {
            background-color: #f0f8ff;
            border: 1px solid #0079bf;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-section h4 {
            margin: 0 0 8px 0;
            color: #0079bf;
        }
        
        .debug-section pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .member-item {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .member-item:hover {
            background-color: #f4f5f7;
        }
        
        .member-item.selected {
            background-color: #e4f3ff;
            border: 2px solid #0079bf;
        }
        
        .member-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }
        
        .create-approval-button {
            margin-top: 20px;
            padding: 12px 16px;
            background-color: #0079bf;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 600;
        }
        
        .member-item-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="debug-section">
        <h4>üîç Debug Information</h4>
        <div id="debug-info">Loading debug info...</div>
    </div>
    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading board members...</p>
    </div>
    
    <div id="content" class="content hidden">
        <div class="header">
            <h3>Create Approvals</h3>
            <div id="member-count" class="member-count"></div>
            <div id="selected-count" class="selected-count">No members selected</div>
        </div>
        <div id="members-list" class="members-list"></div>
        <button id="create-approval-button" class="create-approval-button" disabled>
            Create Approvals
        </button>
    </div>
    
    <div id="error" class="error hidden">
        <p>Unable to load board members</p>
        <button id="retry-btn" class="btn">Retry</button>
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();
        var allMembers = [];
        var selectedMembers = [];
        var debugInfo = document.getElementById('debug-info');

        function addDebugInfo(title, data) {
            var debugSection = document.createElement('div');
            debugSection.innerHTML = '<strong>' + title + ':</strong><br><pre>' + JSON.stringify(data, null, 2) + '</pre><br>';
            debugInfo.appendChild(debugSection);
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            var errorDiv = document.getElementById('error');
            var errorMsg = errorDiv.querySelector('p');
            errorMsg.textContent = message || 'Unable to load board members';
        }
        
        function loadBoardMembers() {
            showLoading();
            addDebugInfo('üöÄ Starting member loading process', 'Initializing...');
            
            console.log('Starting to load board members...');
            
            // First try to get board information
            t.board('all')
            .then(function(board) {
                console.log('Board info:', board);
                addDebugInfo('üìã Board Data (t.board("all"))', {
                    id: board.id,
                    name: board.name,
                    idOrganization: board.idOrganization,
                    hasMembers: !!board.members,
                    membersCount: board.members ? board.members.length : 0,
                    members: board.members || 'No members property'
                });
                
                // Check if we have organization info
                if (board.idOrganization) {
                    addDebugInfo('üè¢ Board has organization', 'ID: ' + board.idOrganization);
                    console.log('Board has organization:', board.idOrganization);
                    // Try to get organization info
                    return t.organization('all');
                } else {
                    addDebugInfo('üë§ Board is personal (no organization)', 'Trying board members directly');
                    console.log('Board is not part of a workspace, trying board members');
                    
                    // Try t.board('members') directly
                    return t.board('members').then(function(members) {
                        addDebugInfo('üë• t.board("members") result', {
                            hasMembers: !!members,
                            count: members ? members.length : 0,
                            members: members
                        });
                        
                        if (members && members.length > 0) {
                            allMembers = members;
                            displayMembers(members);
                            showContent();
                            
                            var header = document.querySelector('.header h3');
                            header.textContent = 'Create Approvals - Board Members (' + members.length + ')';
                            return;
                        } else {
                            throw new Error('No board members found via t.board("members")');
                        }
                    });
                }
            })
            .then(function(org) {
                if (!org) return; // Already handled board members case above
                
                console.log('Organization info:', org);
                addDebugInfo('üè¢ Organization Data (t.organization("all"))', {
                    id: org.id,
                    name: org.name,
                    displayName: org.displayName,
                    hasMembers: !!org.members,
                    membersCount: org.members ? org.members.length : 0,
                    members: org.members || 'No members property'
                });
                
                // Try to get organization members using available methods
                if (org.members) {
                    addDebugInfo('‚úÖ Found members in organization object', 'Count: ' + org.members.length);
                    console.log('Found members in organization object');
                    allMembers = org.members;
                    displayMembers(org.members);
                    showContent();
                } else {
                    addDebugInfo('‚ö†Ô∏è No members in org object, trying board members fallback', 'Attempting t.board("members")');
                    console.log('No members in org object, falling back to board members');
                    return t.board('members').then(function(members) {
                        addDebugInfo('üë• Fallback t.board("members") result', {
                            hasMembers: !!members,
                            count: members ? members.length : 0,
                            members: members
                        });
                        
                        if (members && members.length > 0) {
                            allMembers = members;
                            displayMembers(members);
                            showContent();
                            
                            var header = document.querySelector('.header h3');
                            header.textContent = 'Create Approvals - Board Members (' + members.length + ')';
                        } else {
                            throw new Error('No members found in fallback');
                        }
                    });
                }
            })
            .catch(function(error) {
                console.error('Error loading members:', error);
                addDebugInfo('‚ùå Error occurred', {
                    message: error.message,
                    stack: error.stack
                });
                
                // Try one more fallback - current member only
                addDebugInfo('üîÑ Trying final fallback - current member only', 'Using t.member("all")');
                t.member('all').then(function(currentMember) {
                    addDebugInfo('üë§ Current Member Data', currentMember);
                    
                    if (currentMember) {
                        console.log('Showing current member as fallback');
                        allMembers = [currentMember];
                        displayMembers([currentMember]);
                        showContent();
                        
                        var header = document.querySelector('.header h3');
                        header.textContent = '‚ö†Ô∏è Current Member Only (Limited Access)';
                    } else {
                        throw new Error('No member data available');
                    }
                }).catch(function(finalError) {
                    console.error('All methods failed:', finalError);
                    addDebugInfo('üí• All methods failed', {
                        finalError: finalError.message,
                        originalError: error.message
                    });
                    
                    showError('Unable to load any member data. Check debug info above.');
                });
            });
        }
        
        function displayMembers(members) {
            var membersList = document.getElementById('members-list');
            var memberCount = document.getElementById('member-count');
            
            addDebugInfo('üé® Displaying Members', {
                count: members.length,
                memberNames: members.map(m => m.fullName || m.username)
            });
            
            memberCount.textContent = members.length + ' member' + (members.length !== 1 ? 's' : '');
            membersList.innerHTML = '';
            
            members.forEach(function(member) {
                var memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.dataset.memberId = member.id;
                
                var memberContent = document.createElement('div');
                memberContent.className = 'member-item-content';
                
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'member-checkbox';
                
                var avatar = document.createElement('div');
                avatar.className = 'avatar avatar-initials';
                avatar.textContent = member.initials || 
                    (member.username ? member.username.charAt(0).toUpperCase() : 
                     (member.fullName ? member.fullName.charAt(0).toUpperCase() : '?'));
                
                var memberInfo = document.createElement('div');
                memberInfo.className = 'member-info';
                
                var name = document.createElement('div');
                name.className = 'member-name';
                name.textContent = member.fullName || member.username || 'Unknown Member';
                
                memberInfo.appendChild(name);
                
                if (member.username) {
                    var username = document.createElement('div');
                    username.className = 'member-username';
                    username.textContent = '@' + member.username;
                    memberInfo.appendChild(username);
                }
                
                memberContent.appendChild(checkbox);
                memberContent.appendChild(avatar);
                memberContent.appendChild(memberInfo);
                memberItem.appendChild(memberContent);
                
                membersList.appendChild(memberItem);
            });
        }
        
        // Event listeners
        document.getElementById('retry-btn').addEventListener('click', function() {
            loadBoardMembers();
        });
        
        // Load members when popup opens
        loadBoardMembers();
    </script>
</body>
</html>