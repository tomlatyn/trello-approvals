<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Workspace Members</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading workspace members...</p>
    </div>
    
    <div id="content" class="content hidden">
        <div class="header">
            <h3>Workspace Members</h3>
            <div id="member-count" class="member-count"></div>
        </div>
        <div id="members-list" class="members-list"></div>
    </div>
    
    <div id="error" class="error hidden">
        <p>Unable to load workspace members</p>
        <button id="retry-btn" class="btn">Retry</button>
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();
        
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }
        
        function loadWorkspaceMembers() {
            showLoading();
            
            // First, let's check what we can access
            console.log('Starting to load workspace members...');
            
            // Get board information first
            t.board('all')
            .then(function(board) {
                console.log('Board info:', board);
                
                // Check if board has an organization
                if (!board.idOrganization) {
                    throw new Error('This board is not part of a workspace. Please try on a workspace board.');
                }
                
                // Get organization (workspace) information
                return t.organization('all');
            })
            .then(function(org) {
                console.log('Organization info:', org);
                
                if (!org || !org.id) {
                    throw new Error('Unable to access workspace information');
                }
                
                // Get workspace members using Trello API
                console.log('Fetching members for organization:', org.id);
                return t.rest('GET', 'organizations/' + org.id + '/members', {
                    fields: 'fullName,username,avatarUrl,initials,memberType'
                });
            })
            .then(function(members) {
                console.log('Members loaded:', members);
                displayMembers(members);
                showContent();
            })
            .catch(function(error) {
                console.error('Error loading members:', error);
                
                // Show more specific error message
                var errorDiv = document.getElementById('error');
                var errorMsg = errorDiv.querySelector('p');
                
                if (error.message.includes('workspace board')) {
                    errorMsg.textContent = 'This board is not part of a workspace. Please try on a workspace/team board.';
                } else if (error.message.includes('access')) {
                    errorMsg.textContent = 'Unable to access workspace data. Check Power-Up permissions.';
                } else {
                    errorMsg.textContent = 'Unable to load workspace members: ' + error.message;
                }
                
                showError();
            });
        }
        
        function displayMembers(members) {
            var membersList = document.getElementById('members-list');
            var memberCount = document.getElementById('member-count');
            
            // Update member count
            memberCount.textContent = members.length + ' member' + (members.length !== 1 ? 's' : '');
            
            // Clear existing content
            membersList.innerHTML = '';
            
            // Sort members by full name
            members.sort(function(a, b) {
                return (a.fullName || a.username).localeCompare(b.fullName || b.username);
            });
            
            // Create member items
            members.forEach(function(member) {
                var memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                var avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                if (member.avatarUrl) {
                    var img = document.createElement('img');
                    img.src = member.avatarUrl + '/50.png';
                    img.alt = member.fullName || member.username;
                    avatar.appendChild(img);
                } else {
                    avatar.textContent = member.initials || '?';
                    avatar.classList.add('avatar-initials');
                }
                
                var memberInfo = document.createElement('div');
                memberInfo.className = 'member-info';
                
                var name = document.createElement('div');
                name.className = 'member-name';
                name.textContent = member.fullName || member.username;
                
                var username = document.createElement('div');
                username.className = 'member-username';
                username.textContent = '@' + member.username;
                
                var memberType = document.createElement('div');
                memberType.className = 'member-type';
                memberType.textContent = member.memberType || 'normal';
                
                memberInfo.appendChild(name);
                memberInfo.appendChild(username);
                if (member.memberType && member.memberType !== 'normal') {
                    memberInfo.appendChild(memberType);
                }
                
                memberItem.appendChild(avatar);
                memberItem.appendChild(memberInfo);
                
                membersList.appendChild(memberItem);
            });
        }
        
        // Retry button functionality
        document.getElementById('retry-btn').addEventListener('click', function() {
            loadWorkspaceMembers();
        });
        
        // Load members when popup opens
        loadWorkspaceMembers();
    </script>
</body>
</html>