var t = TrelloPowerUp.iframe();

function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('content').classList.add('hidden');
    document.getElementById('error').classList.add('hidden');
}

function showContent() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    document.getElementById('error').classList.add('hidden');
}

function showError(message) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.add('hidden');
    document.getElementById('error').classList.remove('hidden');
    
    var errorDiv = document.getElementById('error');
    var errorMsg = errorDiv.querySelector('p');
    errorMsg.textContent = message || 'Unable to load workspace members';
}

function loadWorkspaceMembers() {
    showLoading();
    
    console.log('Starting to load workspace members...');
    
    // Try multiple approaches to get members
    Promise.all([
        // Approach 1: Try to get board members first
        t.board('all').catch(e => ({ error: 'board', message: e.message })),
        // Approach 2: Try to get organization directly
        t.organization('all').catch(e => ({ error: 'org', message: e.message }))
    ])
    .then(function(results) {
        var board = results[0];
        var org = results[1];
        
        console.log('Board result:', board);
        console.log('Organization result:', org);
        
        // Check if we got valid board data
        if (board && !board.error) {
            console.log('Board info available:', board);
            
            // If board has members, show them
            if (board.members && board.members.length > 0) {
                console.log('Using board members');
                displayMembers(board.members);
                showContent();
                return;
            }
            
            // If board has organization, try to get org members
            if (board.idOrganization) {
                console.log('Board has organization, trying to get org members');
                return loadOrganizationMembers(board.idOrganization);
            }
        }
        
        // Try using organization data if available
        if (org && !org.error && org.id) {
            console.log('Using organization data');
            return loadOrganizationMembers(org.id);
        }
        
        // If neither approach worked, try alternative methods
        return tryAlternativeApproaches();
    })
    .catch(function(error) {
        console.error('Error in loadWorkspaceMembers:', error);
        showError('Unable to access workspace data. Make sure this board is part of a workspace and you have proper permissions.');
    });
}

function loadOrganizationMembers(orgId) {
    console.log('Loading members for organization:', orgId);
    
    // Try different API endpoints
    var apiCalls = [
        // Try the standard members endpoint
        t.rest('GET', 'organizations/' + orgId + '/members', {
            fields: 'fullName,username,avatarUrl,initials,memberType'
        }),
        // Try the memberships endpoint
        t.rest('GET', 'organizations/' + orgId + '/memberships', {
            member: true,
            member_fields: 'fullName,username,avatarUrl,initials'
        })
    ];
    
    return Promise.allSettled(apiCalls)
    .then(function(results) {
        console.log('API call results:', results);
        
        // Try to use the first successful result
        for (var i = 0; i < results.length; i++) {
            if (results[i].status === 'fulfilled' && results[i].value) {
                var members = results[i].value;
                
                // Handle memberships format
                if (members.length > 0 && members[0].member) {
                    members = members.map(function(membership) {
                        return membership.member;
                    });
                }
                
                if (members && members.length > 0) {
                    displayMembers(members);
                    showContent();
                    return;
                }
            }
        }
        
        throw new Error('No members found in API responses');
    });
}

function tryAlternativeApproaches() {
    console.log('Trying alternative approaches...');
    
    // Try to get current member info as a fallback
    return t.member('all')
    .then(function(currentMember) {
        console.log('Current member info:', currentMember);
        
        if (currentMember) {
            // Show just the current member as a fallback
            displayMembers([currentMember]);
            showContent();
            
            // Update the header to indicate this is limited data
            var header = document.querySelector('.header h3');
            header.textContent = 'Current Member (Limited Access)';
        } else {
            throw new Error('Unable to access any member information');
        }
    })
    .catch(function(error) {
        console.error('All approaches failed:', error);
        showError('Unable to load workspace members. This may be due to insufficient permissions or the board not being part of a workspace.');
    });
}

function displayMembers(members) {
    var membersList = document.getElementById('members-list');
    var memberCount = document.getElementById('member-count');
    
    // Update member count
    memberCount.textContent = members.length + ' member' + (members.length !== 1 ? 's' : '');
    
    // Clear existing content
    membersList.innerHTML = '';
    
    // Sort members by full name
    members.sort(function(a, b) {
        var nameA = a.fullName || a.username || '';
        var nameB = b.fullName || b.username || '';
        return nameA.localeCompare(nameB);
    });
    
    // Create member items
    members.forEach(function(member) {
        var memberItem = document.createElement('div');
        memberItem.className = 'member-item';
        
        var avatar = document.createElement('div');
        avatar.className = 'avatar';
        
        if (member.avatarUrl) {
            var img = document.createElement('img');
            img.src = member.avatarUrl + '/50.png';
            img.alt = member.fullName || member.username;
            avatar.appendChild(img);
        } else {
            avatar.textContent = member.initials || (member.username ? member.username.charAt(0).toUpperCase() : '?');
            avatar.classList.add('avatar-initials');
        }
        
        var memberInfo = document.createElement('div');
        memberInfo.className = 'member-info';
        
        var name = document.createElement('div');
        name.className = 'member-name';
        name.textContent = member.fullName || member.username || 'Unknown';
        
        var username = document.createElement('div');
        username.className = 'member-username';
        username.textContent = member.username ? '@' + member.username : '';
        
        memberInfo.appendChild(name);
        if (member.username) {
            memberInfo.appendChild(username);
        }
        
        if (member.memberType && member.memberType !== 'normal') {
            var memberType = document.createElement('div');
            memberType.className = 'member-type';
            memberType.textContent = member.memberType;
            memberInfo.appendChild(memberType);
        }
        
        memberItem.appendChild(avatar);
        memberItem.appendChild(memberInfo);
        
        membersList.appendChild(memberItem);
    });
}

// Retry button functionality
document.getElementById('retry-btn').addEventListener('click', function() {
    loadWorkspaceMembers();
});

// Load members when popup opens
loadWorkspaceMembers();