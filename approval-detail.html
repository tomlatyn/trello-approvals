<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Manage Approvals</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .approval-member {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #dfe1e6;
        }
        
        .approval-member.can-action {
            background-color: #fff2d1;
            border-color: #ff9f1a;
        }
        
        .approval-member-info {
            flex: 1;
            margin-right: 12px;
        }
        
        .approval-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 70px;
            text-align: center;
        }
        
        .status-pending {
            background-color: #fff2d1;
            color: #ff9f1a;
        }
        
        .status-approved {
            background-color: #e3fcef;
            color: #00875a;
        }
        
        .status-rejected {
            background-color: #ffebe6;
            color: #de350b;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        
        .approve-btn {
            background-color: #00875a;
            color: white;
        }
        
        .approve-btn:hover {
            background-color: #006644;
        }
        
        .reject-btn {
            background-color: #de350b;
            color: white;
        }
        
        .reject-btn:hover {
            background-color: #bf2600;
        }
        
        .approval-summary {
            background-color: #f4f5f7;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .summary-item:last-child {
            margin-bottom: 0;
        }
        
        .no-approvals {
            text-align: center;
            padding: 40px 20px;
            color: #6b778c;
        }
        
        .create-approvals-btn {
            background-color: #0079bf;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 12px;
        }
        
        .create-approvals-btn:hover {
            background-color: #005a8b;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading approvals...</p>
    </div>
    
    <div id="content" class="content hidden">
        <div class="header">
            <h3>Approval Status</h3>
        </div>
        
        <div id="approval-summary" class="approval-summary hidden">
            <div class="summary-item">
                <span>Total Members:</span>
                <span id="total-count">0</span>
            </div>
            <div class="summary-item">
                <span>Approved:</span>
                <span id="approved-count" style="color: #00875a;">0</span>
            </div>
            <div class="summary-item">
                <span>Rejected:</span>
                <span id="rejected-count" style="color: #de350b;">0</span>
            </div>
            <div class="summary-item">
                <span>Pending:</span>
                <span id="pending-count" style="color: #ff9f1a;">0</span>
            </div>
        </div>
        
        <div id="approvals-list" class="approvals-list"></div>
        
        <div id="no-approvals" class="no-approvals hidden">
            <p>No approvals have been created for this card yet.</p>
            <button id="create-approvals-btn" class="create-approvals-btn">Create Approvals</button>
        </div>
    </div>
    
    <div id="error" class="error hidden">
        <p>Unable to load approvals</p>
        <button id="retry-btn" class="btn">Retry</button>
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();
        var currentUserId = null;
        var approvalData = null;

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            var errorDiv = document.getElementById('error');
            var errorMsg = errorDiv.querySelector('p');
            errorMsg.textContent = message || 'Unable to load approvals';
        }
        
        function loadApprovals() {
            showLoading();
            
            Promise.all([
                t.get('card', 'shared', 'approvals', null),
                t.member('all')
            ])
            .then(function(results) {
                approvalData = results[0];
                currentUserId = results[1].id;
                
                console.log('Approval data:', approvalData);
                console.log('Current user ID:', currentUserId);
                
                if (!approvalData || !approvalData.members) {
                    showNoApprovals();
                } else {
                    displayApprovals();
                    showContent();
                }
            })
            .catch(function(error) {
                console.error('Error loading approvals:', error);
                showError('Unable to load approvals. Please try again.');
            });
        }
        
        function showNoApprovals() {
            document.getElementById('no-approvals').classList.remove('hidden');
            document.getElementById('approval-summary').classList.add('hidden');
            document.getElementById('approvals-list').innerHTML = '';
            showContent();
        }
        
        function displayApprovals() {
            var approvalsList = document.getElementById('approvals-list');
            var summaryDiv = document.getElementById('approval-summary');
            var noApprovalsDiv = document.getElementById('no-approvals');
            
            noApprovalsDiv.classList.add('hidden');
            summaryDiv.classList.remove('hidden');
            
            approvalsList.innerHTML = '';
            
            var members = Object.values(approvalData.members);
            var totalCount = members.length;
            var approvedCount = members.filter(m => m.status === 'approved').length;
            var rejectedCount = members.filter(m => m.status === 'rejected').length;
            var pendingCount = members.filter(m => m.status === 'pending').length;
            
            // Update summary
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('approved-count').textContent = approvedCount;
            document.getElementById('rejected-count').textContent = rejectedCount;
            document.getElementById('pending-count').textContent = pendingCount;
            
            // Sort members by status (pending first, then approved, then rejected)
            members.sort(function(a, b) {
                var statusOrder = { 'pending': 0, 'approved': 1, 'rejected': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            
            members.forEach(function(member) {
                var memberDiv = document.createElement('div');
                memberDiv.className = 'approval-member';
                
                var canAction = (member.id === currentUserId && member.status === 'pending');
                if (canAction) {
                    memberDiv.classList.add('can-action');
                }
                
                var avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                if (member.avatarUrl) {
                    var avatarUrl = member.avatarUrl;
                    if (!avatarUrl.includes('/50.png')) {
                        avatarUrl += '/50.png';
                    }
                    
                    var img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = member.fullName || member.username;
                    avatar.appendChild(img);
                } else {
                    avatar.textContent = member.fullName ? member.fullName.charAt(0).toUpperCase() : '?';
                    avatar.classList.add('avatar-initials');
                }
                
                var memberInfo = document.createElement('div');
                memberInfo.className = 'approval-member-info';
                
                var name = document.createElement('div');
                name.className = 'member-name';
                name.textContent = member.fullName || member.username || 'Unknown Member';
                
                memberInfo.appendChild(name);
                
                if (member.username) {
                    var username = document.createElement('div');
                    username.className = 'member-username';
                    username.textContent = '@' + member.username;
                    memberInfo.appendChild(username);
                }
                
                var statusSpan = document.createElement('span');
                statusSpan.className = 'approval-status status-' + member.status;
                statusSpan.textContent = member.status;
                
                memberDiv.appendChild(avatar);
                memberDiv.appendChild(memberInfo);
                memberDiv.appendChild(statusSpan);
                
                // Add action buttons if current user can act
                if (canAction) {
                    var actionButtons = document.createElement('div');
                    actionButtons.className = 'action-buttons';
                    
                    var approveBtn = document.createElement('button');
                    approveBtn.className = 'action-btn approve-btn';
                    approveBtn.textContent = 'Approve';
                    approveBtn.addEventListener('click', function() {
                        updateApprovalStatus(member.id, 'approved');
                    });
                    
                    var rejectBtn = document.createElement('button');
                    rejectBtn.className = 'action-btn reject-btn';
                    rejectBtn.textContent = 'Reject';
                    rejectBtn.addEventListener('click', function() {
                        updateApprovalStatus(member.id, 'rejected');
                    });
                    
                    actionButtons.appendChild(approveBtn);
                    actionButtons.appendChild(rejectBtn);
                    memberDiv.appendChild(actionButtons);
                }
                
                approvalsList.appendChild(memberDiv);
            });
        }
        
        function updateApprovalStatus(memberId, status) {
            if (!approvalData || !approvalData.members[memberId]) {
                console.error('Invalid approval data or member ID');
                return;
            }
            
            // Update the member's status
            approvalData.members[memberId].status = status;
            approvalData.members[memberId].actionDate = new Date().toISOString();
            
            // Save updated data
            t.set('card', 'shared', 'approvals', approvalData)
            .then(function() {
                console.log('Approval status updated successfully');
                // Refresh the display
                displayApprovals();
            })
            .catch(function(error) {
                console.error('Error updating approval status:', error);
                alert('Failed to update approval status. Please try again.');
            });
        }
        
        // Event listeners
        document.getElementById('retry-btn').addEventListener('click', function() {
            loadApprovals();
        });
        
        document.getElementById('create-approvals-btn').addEventListener('click', function() {
            t.popup({
                title: 'Create Approvals',
                url: './popup.html',
                height: 450,
                width: 350
            });
        });
        
        // Load approvals when popup opens
        loadApprovals();
    </script>
</body>
</html>