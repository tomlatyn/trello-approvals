<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Approval Status</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: white;
            color: #172b4d;
            font-size: 14px;
            line-height: 1.4;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        /* Main container */
        .approval-container {
            background-color: white;
            overflow: hidden;
        }
        
        /* Header */
        .approval-header {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-bottom: 1px solid #e1e4e8;
            font-weight: 600;
            font-size: 14px;
            color: #24292e;
        }
        
        /* Member rows */
        .approval-member {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #e1e4e8;
            transition: background-color 0.1s ease;
        }
        
        .approval-member:last-child {
            border-bottom: none;
        }
        
        .approval-member:hover {
            background-color: #f6f8fa;
        }
        
        .approval-member.current-user {
            background-color: #fff8e1;
            border-left: 3px solid #ffc107;
        }
        
        .approval-member.current-user:hover {
            background-color: #fff3cd;
        }
        
        /* Member info section */
        .member-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        /* Avatar */
        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            overflow: hidden;
            background: linear-gradient(45deg, #0366d6, #0256cc);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .member-name {
            font-weight: 500;
            color: #24292e;
            font-size: 14px;
        }
        
        /* Status section */
        .status-section {
            width: 100px;
            display: flex;
            justify-content: flex-start;
            margin-right: 8px;
        }
        
        .approval-status {
            padding: 4px 8px;
            border-radius: 0px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .status-pending {
            background-color: #7c3aed;
            color: white;
        }
        
        .status-approved {
            background-color: #10b981;
            color: white;
        }
        
        .status-rejected {
            background-color: #ef4444;
            color: white;
        }
        
        /* Status banner at bottom */
        .status-banner {
            padding: 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: white;
            margin-top: 8px;
            border-radius: 0px;
        }
        
        .banner-pending {
            background-color: #7c3aed;
        }
        
        .banner-approved {
            background-color: #10b981;
        }
        
        .banner-rejected {
            background-color: #ef4444;
        }
        
        /* Empty states */
        .no-approvals {
            text-align: center;
            padding: 20px;
            color: #6b778c;
            font-style: italic;
            font-size: 13px;
            background-color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b778c;
            font-size: 13px;
            background-color: white;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #ef4444;
            font-size: 13px;
            background-color: white;
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e1e4e8;
            border-radius: 50%;
            border-top-color: #0366d6;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.1s ease;
            flex-shrink: 0;
            margin-right: 16px;
        }
        
        .approval-member:hover .action-buttons,
        .approval-member.current-user .action-buttons {
            opacity: 1;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.1s ease;
            background-color: #f0f0f0;
            color: #42526e;
            display: flex;
            align-items: center;
            gap: 6px;
            height: 32px;
            box-sizing: border-box;
        }
        
        .action-btn:hover {
            background-color: #e0e0e0;
            color: #172b4d;
        }
        
        .approve-btn {
            background-color: #10b981;
            color: white;
        }
        
        .approve-btn:hover {
            background-color: #10b981b7;
        }
        
        .reject-btn {
            background-color: #ef4444;
            color: white;
        }
        
        .reject-btn:hover {
            background-color: #ef4444cc;
        }
        
        .reset-btn {
            background-color: #f0f0f0;
            color: #6b778c;
            border: 1px solid #dfe1e6;
        }
        
        .reset-btn:hover {
            background-color: #e0e0e0;
            color: #42526e;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 400px) {
            .approval-member {
                padding: 6px 8px;
            }
            
            .approval-header {
                padding: 6px 8px;
            }
            
            .avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .member-name {
                font-size: 13px;
            }
            
            .status-section {
                width: 80px;
            }
            
            .action-buttons {
                opacity: 1; /* Always show on mobile */
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <span class="spinner"></span>
        Loading approvals...
    </div>
    
    <div id="approval-container" class="approval-container" style="display: none;">
        <div id="approvals-list"></div>
    </div>
    
    <div id="status-banner-container"></div>
    
    <div id="no-approvals" class="no-approvals" style="display: none;">
        No approvals have been created for this card yet.
    </div>
    
    <div id="error" class="error" style="display: none;">
        Unable to load approval status.
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();
        var currentUserId = null;
        var approvalData = null;

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('approval-container').style.display = 'none';
            document.getElementById('status-banner-container').innerHTML = '';
            document.getElementById('no-approvals').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }
        
        function showApprovals() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('approval-container').style.display = 'block';
            document.getElementById('no-approvals').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            resizeToContent();
        }
        
        function showNoApprovals() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('approval-container').style.display = 'none';
            document.getElementById('status-banner-container').innerHTML = '';
            document.getElementById('no-approvals').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            resizeToContent();
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('approval-container').style.display = 'none';
            document.getElementById('status-banner-container').innerHTML = '';
            document.getElementById('no-approvals').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        function resizeToContent() {
            setTimeout(function() {
                var body = document.body;
                var html = document.documentElement;
                
                var height = Math.max(
                    body.scrollHeight,
                    body.offsetHeight,
                    html.clientHeight,
                    html.scrollHeight,
                    html.offsetHeight
                );
                
                height += 20;
                
                t.sizeTo('body').catch(function(error) {
                    console.log('Resize failed, trying alternative:', error);
                    t.sizeTo('#approval-container');
                });
            }, 50);
        }
        
        function loadApprovals() {
            showLoading();
            
            // Use placeholder data for testing
            var usePlaceholder = false; // Set to false when deploying to Trello
            
            if (usePlaceholder) {
                // Placeholder data for testing
                currentUserId = 'user123';
                approvalData = {
                    members: {
                        'user123': {
                            id: 'user123',
                            fullName: 'John Doe',
                            username: 'johndoe',
                            avatarUrl: 'https://i.pravatar.cc/150?img=1',
                            status: 'pending',
                            actionDate: new Date().toISOString()
                        },
                        'user456': {
                            id: 'user456',
                            fullName: 'Jane Smith',
                            username: 'janesmith',
                            avatarUrl: 'https://i.pravatar.cc/150?img=2',
                            status: 'approved',
                            actionDate: new Date().toISOString()
                        },
                        'user789': {
                            id: 'user789',
                            fullName: 'Mike Johnson',
                            username: 'mikej',
                            avatarUrl: null, // This will show initials
                            status: 'rejected',
                            actionDate: new Date().toISOString()
                        },
                        'user101': {
                            id: 'user101',
                            fullName: 'Sarah Wilson',
                            username: 'sarahw',
                            avatarUrl: 'https://i.pravatar.cc/150?img=3',
                            status: 'pending',
                            actionDate: new Date().toISOString()
                        },
                        'user202': {
                            id: 'user202',
                            fullName: 'Tom Brown',
                            username: 'tombrown',
                            avatarUrl: 'https://i.pravatar.cc/150?img=4',
                            status: 'approved',
                            actionDate: new Date().toISOString()
                        }
                    }
                };
                
                console.log('Using placeholder data:', approvalData);
                displayApprovals();
                showApprovals();
                return;
            }
            
            // Real Trello implementation
            t.member('all')
            .then(function(currentMember) {
                currentUserId = currentMember.id;
                console.log('Current user ID:', currentUserId);
                
                return t.get('card', 'shared', 'approvals');
            })
            .then(function(data) {
                approvalData = data;
                console.log('Approval data loaded:', approvalData);
                
                if (!approvalData || !approvalData.members || Object.keys(approvalData.members).length === 0) {
                    console.log('No approval data found');
                    showNoApprovals();
                } else {
                    console.log('Displaying approvals for', Object.keys(approvalData.members).length, 'members');
                    displayApprovals();
                    showApprovals();
                }
            })
            .catch(function(error) {
                console.error('Error loading approvals:', error);
                showError();
            });
        }
        
        function displayApprovals() {
            var approvalsList = document.getElementById('approvals-list');
            var statusBannerContainer = document.getElementById('status-banner-container');
            
            approvalsList.innerHTML = '';
            statusBannerContainer.innerHTML = '';
            
            var members = Object.values(approvalData.members);
            
            // Sort members by name
            members.sort(function(a, b) {
                var nameA = (a.fullName || a.username || '').toLowerCase();
                var nameB = (b.fullName || b.username || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            // Display each member
            members.forEach(function(member) {
                var memberDiv = document.createElement('div');
                memberDiv.className = 'approval-member';
                
                // Check if this is the current user
                var isCurrentUser = (member.id === currentUserId);
                if (isCurrentUser) {
                    memberDiv.classList.add('current-user');
                }
                
                // Member info section
                var memberInfo = document.createElement('div');
                memberInfo.className = 'member-info';
                
                var avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                if (member.avatarUrl) {
                    var img = document.createElement('img');
                    img.src = member.avatarUrl;
                    img.alt = member.fullName || member.username;
                    img.onerror = function() {
                        avatar.innerHTML = '';
                        avatar.textContent = getInitials(member);
                    };
                    avatar.appendChild(img);
                } else {
                    avatar.textContent = getInitials(member);
                }
                
                var name = document.createElement('div');
                name.className = 'member-name';
                name.textContent = member.fullName || member.username || 'Unknown Member';
                
                memberInfo.appendChild(avatar);
                memberInfo.appendChild(name);
                
                // Status section
                var statusSection = document.createElement('div');
                statusSection.className = 'status-section';
                
                var statusSpan = document.createElement('span');
                statusSpan.className = 'approval-status status-' + member.status;
                statusSpan.textContent = member.status;
                
                statusSection.appendChild(statusSpan);
                
                memberDiv.appendChild(memberInfo);
                
                // Add action buttons if current user can act
                if (isCurrentUser) {
                    var actionButtons = createActionButtons(member);
                    memberDiv.appendChild(actionButtons);
                }
                
                memberDiv.appendChild(statusSection);
                
                approvalsList.appendChild(memberDiv);
            });
            
            // Create status banner based on overall approval status
            var overallStatus = calculateOverallStatus(members);
            createStatusBanner(overallStatus);
            
            resizeToContent();
        }
        
        function calculateOverallStatus(members) {
            // Count each status type
            var statusCounts = {
                pending: 0,
                approved: 0,
                rejected: 0
            };
            
            members.forEach(function(member) {
                if (statusCounts.hasOwnProperty(member.status)) {
                    statusCounts[member.status]++;
                }
            });
            
            console.log('Status counts:', statusCounts);
            
            // Apply the logic:
            // 1. If there are any pending approvals -> "pending"
            // 2. If no pending and at least one rejected -> "rejected"
            // 3. If all are approved -> "approved"
            
            if (statusCounts.pending > 0) {
                return 'pending';
            } else if (statusCounts.rejected > 0) {
                return 'rejected';
            } else if (statusCounts.approved > 0) {
                return 'approved';
            } else {
                // Fallback case (shouldn't happen with valid data)
                return 'pending';
            }
        }
        
        function createActionButtons(member) {
            var actionButtons = document.createElement('div');
            actionButtons.className = 'action-buttons';
            
            if (member.status === 'approved') {
                actionButtons.appendChild(createButton('Reject', 'reject-btn', function() {
                    updateApprovalStatus(member.id, 'rejected');
                }));
                actionButtons.appendChild(createButton('Reset', 'reset-btn', function() {
                    updateApprovalStatus(member.id, 'pending');
                }));
                
            } else if (member.status === 'rejected') {
                actionButtons.appendChild(createButton('Approve', 'approve-btn', function() {
                    updateApprovalStatus(member.id, 'approved');
                }));
                actionButtons.appendChild(createButton('Reset', 'reset-btn', function() {
                    updateApprovalStatus(member.id, 'pending');
                }));
                
            } else { // pending
                actionButtons.appendChild(createButton('Approve', 'approve-btn', function() {
                    updateApprovalStatus(member.id, 'approved');
                }));
                actionButtons.appendChild(createButton('Reject', 'reject-btn', function() {
                    updateApprovalStatus(member.id, 'rejected');
                }));
            }
            
            return actionButtons;
        }
        
        function createButton(text, className, onClick) {
            var button = document.createElement('button');
            button.className = 'action-btn ' + className;
            
            // Add icons to approve and reject buttons
            if (className.includes('approve-btn')) {
                var icon = document.createElement('span');
                icon.className = 'btn-icon';
                icon.innerHTML = '✓';
                button.appendChild(icon);
            } else if (className.includes('reject-btn')) {
                var icon = document.createElement('span');
                icon.className = 'btn-icon';
                icon.innerHTML = '✕';
                button.appendChild(icon);
            }
            
            var textSpan = document.createElement('span');
            textSpan.textContent = text;
            button.appendChild(textSpan);
            
            button.addEventListener('click', onClick);
            return button;
        }
        
        function updateApprovalStatus(memberId, status) {
            console.log('Updating approval status for member:', memberId, 'to:', status);
            
            if (!approvalData || !approvalData.members || !approvalData.members[memberId]) {
                console.error('Invalid approval data or member ID:', memberId);
                console.log('Current approval data:', approvalData);
                return;
            }
            
            // Update the member's status
            approvalData.members[memberId].status = status;
            approvalData.members[memberId].actionDate = new Date().toISOString();
            
            console.log('Updated approval data:', approvalData);
            
            // For placeholder data, just refresh immediately
            var usePlaceholder = false; // Should match the flag in loadApprovals
            
            if (usePlaceholder) {
                console.log('Approval status updated successfully (placeholder mode)');
                displayApprovals();
                return;
            }
            
            // Save updated data using the same pattern as your working popup
            t.set('card', 'shared', 'approvals', approvalData)
            .then(function() {
                console.log('Approval status updated successfully');
                // Refresh the display
                displayApprovals();
            })
            .catch(function(error) {
                console.error('Error updating approval status:', error);
                alert('Failed to update approval status. Please try again.');
                
                // Reload the approvals to reset the display
                loadApprovals();
            });
        }
        
        function createStatusBanner(status) {
            var statusBannerContainer = document.getElementById('status-banner-container');
            var banner = document.createElement('div');
            banner.className = 'status-banner banner-' + status;
            banner.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusBannerContainer.appendChild(banner);
        }
        
        function getInitials(member) {
            if (member.fullName) {
                var parts = member.fullName.split(' ');
                return parts.length > 1 ? 
                    parts[0].charAt(0).toUpperCase() + parts[parts.length-1].charAt(0).toUpperCase() :
                    parts[0].charAt(0).toUpperCase();
            } else if (member.username) {
                return member.username.charAt(0).toUpperCase();
            }
            return '?';
        }
        
        // Load approvals when section opens
        loadApprovals();
    </script>
</body>
</html>